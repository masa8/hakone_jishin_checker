<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <title>Device Properties Example</title>
        <meta id="viewport" content="width=device-width; initial-scale=1">
        <link rel="stylesheet"  href="lib/jquery.mobile-1.4.5.min.css" />
        <link rel="stylesheet"  href="css/index.css" />
        <script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="lib/jquery.mobile-1.4.5.min.js"></script>
        <script type="text/javascript" src="lib/countUp.min.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" charset="utf-8">
        
        function onLoad() {
            document.addEventListener("deviceready", onDeviceReady, false);
        }
        
        var today_date = "";
        var today_count = -1;
        var just_updated = true;
        var diff = -1;
        
        var updated_date = "";
        var previous_date = "";
        var numAnim;
        
        function onDeviceReady(){
            
            getsite();
            setInterval(function() {
                        getsite();
            }, 1000*60*15);
        }
        
        function getsite(){
            $.ajax({
                   type: 'GET',
                   dataType: 'html',
                   url: 'http://www.onken.odawara.kanagawa.jp/files/dat_auto/list_N_day.html',
                   success: function(data){
                   
                   var source = $('<div>' + data + '</div>');
                   $('#error_msg').text("");
                   dataprovider(source);
                    updatepage();
                   },
                    error: function(err){
                    $('#error_msg').text("HTML Read Error...");
                   }
            });

        }
        function dataprovider(source) {
            
            // updated_date, previous_date
            $(source).find("CENTER").each(function(loop,item) {
                                      var text = $(item).text().trim();
                                      var re = /(\d+\/\d+\/\d+\s+\d+:\d+)/;
                                      var latest = text.match(re);
                                      var candidate = "最終更新時刻: " + latest[1];
                                      
                                      //INIT
                                      if ( updated_date == "" ) {
                                          updated_date = candidate;
                                          previous_date = candidate;
                                      
                                      // NOT UPDATED
                                      }else if ( updated_date == candidate ) {
                                          previous_date = updated_date;
                                          
                                      // UPDATED
                                      }else{
                                          previous_date = updated_date;
                                          updated_date = candidate;
                                      }
                                      return false;
                                      });
                                      
                                      
            // today_date, today_count, diff
            $(source).find("LI").each(function(loop,item) {
                                      var text = $(item).text().trim();
                                      var re = /(\d+\/\d+\/\d+)\s+(\d+)/;
                                      var latest = text.match(re);
                                      today_date  = latest[1];
                                
                                      // INIT
                                      if( today_count == -1 ){
                                       today_count = Number(latest[2]);
                                       diff = 0;
                                    
                                      // NO QUAKE
                                      }else if (String(today_count) == latest[2] ){
                                       diff = 0;
                                      // QUAKE HAPPEND
                                      } else {
                                      diff = Number(latest[2]) - today_count;
                                      today_count = Number(latest[2]);
                                      }
                                      return false;
                                      });
                                      
        }
        
        function updatepage(){
            $('#test').text(today_date);
            numAnim = new CountUp("counter", 0, 0);
            numAnim.update(today_count);
            numAnim.start();
            
            $('#updated').text(updated_date);
            $('#prev').text(previous_date);
            $('#diff').text(diff);
            
            if (diff > 0 ){
                navigator.notification.vibrate(diff*1000);
                navigator.notification.beep(diff);
            }

        }
        
        </script>
    </head>
    <body onload="onLoad()">
        
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>箱根の地震を通知音で感じる</h3>
            </div>
            <div data-role="content">
                <center>
                     <div><h2 class="msg" id="error_msg"></h2></div>
                    <div><h2 class="count" id="test"></h2></div><div>の箱根の地震は</div>
                    <div><h1 class="count" id="counter">0</h1>回</div>
                </center>
                <BR>
                <center>
                    <div>
                        <h3 class="count" >前回の</h3>
                        <h3 class="count" id="prev" ></h3>
                        <h3 class="count" >以後発生した地震</h3>
                        <h1 class="count" id="diff"></h1> 回</div>
                    </center>
              
            </div>
            <div data-theme="a" data-role="footer" data-position="fixed">
                <h3 id="updated"></h3>
            </div>
        </div>

    </body>
</html>